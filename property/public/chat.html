<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat - Property Management System</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="container">
      <div class="nav-brand">
        <h1>üè† PropertyHub</h1>
      </div>
      <div class="nav-links">
        <a href="dashboard.html">‚Üê Back to Dashboard</a>
        <span id="userName"></span>
      </div>
    </div>
  </nav>

  <!-- Chat Section -->
  <section class="chat-section">
    <div class="container">
      <div class="chat-container">
        <div class="chat-header">
          <h3>üí¨ Chat with <span id="receiverName"></span></h3>
        </div>

        <div class="chat-messages" id="chatMessages">
          <!-- Messages will appear here -->
        </div>

        <div class="chat-input">
          <input
            type="text"
            id="messageInput"
            placeholder="Type your message..."
            class="form-input"
            onkeypress="handleKeyPress(event)"
          />
          <button onclick="sendMessage()" class="btn-primary">Send</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <script>
    const API_BASE = "http://localhost:5000";
    let socket;
    let currentUser = null;
    let receiverId = null;
    let receiverName = "";

    // ==============================
    // INITIALIZATION
    // ==============================
    window.addEventListener("DOMContentLoaded", () => {
      checkAuth();
    });

    function checkAuth() {
      const token = localStorage.getItem("token");
      const user = JSON.parse(localStorage.getItem("user") || "null");

      if (!token || !user) {
        window.location.href = "login.html";
        return;
      }

      currentUser = user;
      document.getElementById("userName").textContent = user.name;

      const urlParams = new URLSearchParams(window.location.search);
      receiverId = urlParams.get("receiver");
      receiverName = urlParams.get("name") || "User";

      if (!receiverId) {
        alert("Invalid chat session");
        window.location.href = "dashboard.html";
        return;
      }

      document.getElementById("receiverName").textContent = receiverName;

      initChat();
    }

    // ==============================
    // SOCKET CONNECTION
    // ==============================
    function initChat() {
      socket = io(API_BASE);

      socket.on("connect", () => {
        console.log("‚úÖ Connected to chat server");

        socket.emit("join-chat", {
          senderId: String(currentUser.id),
          receiverId: String(receiverId),
        });

        // Load chat history from backend
        socket.emit("load-messages", {
          userId1: String(currentUser.id),
          userId2: String(receiverId),
        });
      });

      socket.on("messages-loaded", (messages) => {
        displayMessages(messages);
      });

      // ‚úÖ Listen for real-time messages
      socket.on("receive-message", (message) => {
        if (
          (String(message.senderId) === String(receiverId) &&
            String(message.receiverId) === String(currentUser.id)) ||
          (String(message.senderId) === String(currentUser.id) &&
            String(message.receiverId) === String(receiverId))
        ) {
          appendMessage(message);
        }
      });

      socket.on("disconnect", () => {
        console.log("‚ùå Disconnected from chat server");
      });
    }

    // ==============================
    // DISPLAY & SEND MESSAGES
    // ==============================
    function displayMessages(messages) {
      const chatMessages = document.getElementById("chatMessages");
      chatMessages.innerHTML = "";

      // Sort messages chronologically
      messages.sort(
        (a, b) => new Date(a.timestamp) - new Date(b.timestamp)
      );

      messages.forEach((msg) => appendMessage(msg));
      scrollToBottom();
    }

    function appendMessage(message) {
      const chatMessages = document.getElementById("chatMessages");
      const messageDiv = document.createElement("div");

      const isSent = String(message.senderId) === String(currentUser.id);
      messageDiv.className = `chat-message ${isSent ? "sent" : "received"}`;

      const time = new Date(message.timestamp).toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
      });

      messageDiv.innerHTML = `
        <div class="message-content">
          <p>${escapeHtml(message.message)}</p>
          <span class="message-time">${time}</span>
        </div>
      `;

      chatMessages.appendChild(messageDiv);
      scrollToBottom();
    }

    // Prevent XSS
    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // ‚úÖ FIXED: Don't append optimistically here, only emit
    function sendMessage() {
      const input = document.getElementById("messageInput");
      const message = input.value.trim();
      if (!message) return;

      const msgData = {
        senderId: String(currentUser.id),
        receiverId: String(receiverId),
        message: message,
        senderName: currentUser.name,
      };

      // Emit to server; UI will update via "receive-message"
      socket.emit("send-message", msgData);

      input.value = "";
    }

    function handleKeyPress(event) {
      if (event.key === "Enter") sendMessage();
    }

    function scrollToBottom() {
      const chatMessages = document.getElementById("chatMessages");
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  </script>
</body>
</html>
